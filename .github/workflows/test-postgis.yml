name: Test with PostGIS

env:
  PLUGIN_NAME: ${{ github.event.repository.name }}

on:
  push:
    branches:
      - main
      - next
  pull_request:
    branches:
      - main
      - next
  workflow_dispatch:

jobs:
  test:
    name: redmine:${{ matrix.redmine_version }} ruby:${{ matrix.ruby_version }} postgis:${{ matrix.db_version }}
    runs-on: ubuntu-22.04
    container:
      image: ruby:${{ matrix.ruby_version }}-bullseye

    strategy:
      fail-fast: false
      matrix:
        redmine_version: [5.0-stable, 5.1-stable, master]
        ruby_version: ['3.0', '3.1', '3.2']
        db_version: [12-3.0, 15-3.3]
        include:
          - system_test: true
            redmine_version: 5.1-stable
            ruby_version: '3.2'
        exclude:
          - redmine_version: 5.0-stable
            ruby_version: '3.2'
          - redmine_version: master

    services:
      postgres:
        image: postgis/postgis:${{ matrix.db_version }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show current directory
        run: pwd

      - name: Set script permissions
        run: chmod +x /scripts/*.sh

      - name: List scripts directory for debugging
        run: ls -l ./scripts

      - name: Checkout Redmine
        uses: actions/checkout@v4
        with:
          repository: redmine/redmine
          ref: ${{ matrix.redmine_version }}
          path: redmine

      - name: Checkout Plugin
        uses: actions/checkout@v4
        with:
          path: redmine/plugins/${{ env.PLUGIN_NAME }}

      - name: Setup Environment
        run: /scripts/setup_environment.sh

      - name: Prepare Plugin
        working-directory: redmine/plugins/${{ env.PLUGIN_NAME }}
        run: /scripts/prepare_plugin.sh

      - name: Prepare Redmine source
        working-directory: redmine
        run: /scripts/prepare_redmine.sh

      - name: Adjust Gem environment
        run: /scripts/adjust_gem_env.sh

      - name: Install Ruby dependencies
        working-directory: redmine
        run: /scripts/install_ruby_dependencies.sh

      - name: Run Redmine rake tasks
        env:
          RAILS_ENV: test
        working-directory: redmine
        run: /scripts/run_rake_tasks.sh

      - name: Zeitwerk check
        env:
          RAILS_ENV: test
        working-directory: redmine
        run: /scripts/zeitwerk_check.sh

      - name: Run tests
        env:
          RAILS_ENV: test
          GOOGLE_CHROME_OPTS_ARGS: "headless,disable-gpu,no-sandbox,disable-dev-shm-usage"
        working-directory: redmine
        run: /scripts/run_tests.sh

      - name: Run uninstall test
        env:
          RAILS_ENV: test
        working-directory: redmine
        run: /scripts/run_uninstall_test.sh
